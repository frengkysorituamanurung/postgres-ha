# Detailed Failover Flow Visualization

## Skenario: Leader (pg1) Crash dan Automatic Failover

### Initial State (T=0s)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        APLIKASI                                 â”‚
â”‚                  (Connected via HAProxy)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ HAProxy  â”‚
                   â”‚ :54320   â”‚
                   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Patroni â”‚      â”‚ Patroni â”‚      â”‚ Patroni â”‚
   â”‚  node1  â”‚      â”‚  node2  â”‚      â”‚  node3  â”‚
   â”‚ :8008   â”‚      â”‚ :8008   â”‚      â”‚ :8008   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   pg1   â”‚      â”‚   pg2   â”‚      â”‚   pg3   â”‚
   â”‚ PRIMARY â”‚â”€â”€â”€â”€â”€â–¶â”‚ STANDBY â”‚      â”‚ STANDBY â”‚
   â”‚ :5432   â”‚ WAL  â”‚ :5432   â”‚      â”‚ :5432   â”‚
   â”‚  TL: 1  â”‚      â”‚  TL: 1  â”‚      â”‚  TL: 1  â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ WAL Stream
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶
        
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   etcd   â”‚
                    â”‚  :2379   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    
Leader Lock: node1 (TTL: 30s, renewed every 10s)
```

---

### T=0s: pg1 Crashes! ğŸ’¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        APLIKASI                                 â”‚
â”‚              âš ï¸  Connections start failing                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ HAProxy  â”‚
                   â”‚ :54320   â”‚
                   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Patroni â”‚      â”‚ Patroni â”‚      â”‚ Patroni â”‚
   â”‚  node1  â”‚      â”‚  node2  â”‚      â”‚  node3  â”‚
   â”‚  ğŸ’€ DEAD â”‚      â”‚ âœ“ ALIVE â”‚      â”‚ âœ“ ALIVE â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   pg1   â”‚      â”‚   pg2   â”‚      â”‚   pg3   â”‚
   â”‚  ğŸ’€ DEAD â”‚  â•³â•³â•³â–¶â”‚ STANDBY â”‚      â”‚ STANDBY â”‚
   â”‚         â”‚      â”‚ :5432   â”‚      â”‚ :5432   â”‚
   â”‚         â”‚      â”‚  TL: 1  â”‚      â”‚  TL: 1  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ WAL Stream stopped!
                           â•³
                    
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   etcd   â”‚
                    â”‚  :2379   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    
Leader Lock: node1 (not being renewed! âš ï¸)

Events:
[00:00:00] pg1 PostgreSQL process dies
[00:00:00] pg1 Patroni loses connection to PostgreSQL
[00:00:00] pg1 stops renewing leader lock in etcd
[00:00:00] pg2 & pg3 lose WAL stream from pg1
```

---

### T=10s: Detection Phase

```
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ HAProxy  â”‚
                   â”‚ :54320   â”‚
                   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Patroni â”‚      â”‚ Patroni â”‚      â”‚ Patroni â”‚
   â”‚  node1  â”‚      â”‚  node2  â”‚      â”‚  node3  â”‚
   â”‚  ğŸ’€ DEAD â”‚      â”‚ ğŸ” CHECK â”‚      â”‚ ğŸ” CHECK â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚                â”‚
                         â–¼                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   pg2    â”‚      â”‚   pg3    â”‚
                    â”‚ STANDBY  â”‚      â”‚ STANDBY  â”‚
                    â”‚  TL: 1   â”‚      â”‚  TL: 1   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚                â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚   etcd   â”‚
                           â”‚  :2379   â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Patroni Loop on pg2 & pg3:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Check PostgreSQL health: âœ“ OK      â”‚
â”‚ 2. Try to get leader info from etcd   â”‚
â”‚    â†’ Leader: node1                     â”‚
â”‚    â†’ Lock TTL: expired! âš ï¸             â”‚
â”‚ 3. Leader is DOWN!                     â”‚
â”‚ 4. Check if I can become leader        â”‚
â”‚    â†’ PostgreSQL running: âœ“             â”‚
â”‚    â†’ Not in maintenance: âœ“             â”‚
â”‚    â†’ No nofailover tag: âœ“              â”‚
â”‚ 5. I am eligible! Start election...    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Events:
[00:00:10] pg2 Patroni loop detects leader lock expired
[00:00:10] pg3 Patroni loop detects leader lock expired
[00:00:10] Both nodes start leader election process
```

---

### T=15s: Leader Election

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   etcd   â”‚
                    â”‚  :2379   â”‚
                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
        â–¼                 â–¼                 â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Patroni â”‚      â”‚ Patroni â”‚      â”‚ Patroni â”‚
   â”‚  node1  â”‚      â”‚  node2  â”‚      â”‚  node3  â”‚
   â”‚  ğŸ’€ DEAD â”‚      â”‚ ğŸ† RACE! â”‚      â”‚ ğŸƒ RACE! â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚                â”‚
                         â–¼                â–¼

Election Race:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pg2: etcd.put('/db/pgcluster/leader',                   â”‚
â”‚              value='node2',                              â”‚
â”‚              ttl=30,                                     â”‚
â”‚              prevExist=False)  â† Arrives FIRST! âœ“       â”‚
â”‚                                                          â”‚
â”‚ pg3: etcd.put('/db/pgcluster/leader',                   â”‚
â”‚              value='node3',                              â”‚
â”‚              ttl=30,                                     â”‚
â”‚              prevExist=False)  â† Arrives SECOND! âœ—      â”‚
â”‚              â†’ Error: Key already exists                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Result:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pg2: SUCCESS! I am the new leader! ğŸ†                   â”‚
â”‚      â†’ Start promotion process                           â”‚
â”‚                                                          â”‚
â”‚ pg3: FAILED! Someone else won                           â”‚
â”‚      â†’ Stay as replica                                   â”‚
â”‚      â†’ Wait for new leader info                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   etcd   â”‚
                    â”‚  :2379   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    
Leader Lock: node2 (TTL: 30s) âœ“ NEW LEADER!

Events:
[00:00:15] pg2 acquires leader lock in etcd
[00:00:15] pg3 fails to acquire lock (already taken)
[00:00:15] pg2 starts promotion to primary
```

---

### T=20s: Promotion Phase

```
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ HAProxy  â”‚
                   â”‚ :54320   â”‚
                   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Patroni â”‚      â”‚ Patroni â”‚      â”‚ Patroni â”‚
   â”‚  node1  â”‚      â”‚  node2  â”‚      â”‚  node3  â”‚
   â”‚  ğŸ’€ DEAD â”‚      â”‚ ğŸ”„ PROMOTEâ”‚     â”‚ â³ WAIT  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚                â”‚
                         â–¼                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   pg2    â”‚      â”‚   pg3    â”‚
                    â”‚ ğŸ”„ PROMOTEâ”‚     â”‚ STANDBY  â”‚
                    â”‚  TL: 1â†’2 â”‚      â”‚  TL: 1   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Promotion Steps on pg2:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Remove recovery.signal                        â”‚
â”‚   $ rm /home/postgres/data/recovery.signal            â”‚
â”‚                                                        â”‚
â”‚ Step 2: Update postgresql.conf                        â”‚
â”‚   hot_standby = off                                   â”‚
â”‚   wal_level = replica                                 â”‚
â”‚                                                        â”‚
â”‚ Step 3: Promote PostgreSQL                            â”‚
â”‚   $ pg_ctl promote -D /home/postgres/data             â”‚
â”‚   â†’ PostgreSQL switches to PRIMARY mode               â”‚
â”‚   â†’ Timeline increments: 1 â†’ 2                        â”‚
â”‚   â†’ Starts accepting WRITE operations                 â”‚
â”‚                                                        â”‚
â”‚ Step 4: Wait for PostgreSQL ready                     â”‚
â”‚   â†’ Check: SELECT pg_is_in_recovery()                 â”‚
â”‚   â†’ Result: false (not in recovery = primary!)        â”‚
â”‚                                                        â”‚
â”‚ Step 5: Update cluster state in etcd                  â”‚
â”‚   /db/pgcluster/members/node2:                        â”‚
â”‚     role: master                                      â”‚
â”‚     state: running                                    â”‚
â”‚     timeline: 2                                       â”‚
â”‚     conn_url: postgresql://pg2:5432                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Events:
[00:00:20] pg2 removes recovery.signal
[00:00:21] pg2 promotes PostgreSQL to primary
[00:00:22] pg2 PostgreSQL timeline changes: 1 â†’ 2
[00:00:23] pg2 starts accepting write operations
[00:00:24] pg2 updates cluster state in etcd
```

---

### T=25s: Replica Reconfiguration

```
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ HAProxy  â”‚
                   â”‚ :54320   â”‚
                   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Patroni â”‚      â”‚ Patroni â”‚      â”‚ Patroni â”‚
   â”‚  node1  â”‚      â”‚  node2  â”‚      â”‚  node3  â”‚
   â”‚  ğŸ’€ DEAD â”‚      â”‚ âœ“ LEADER â”‚      â”‚ ğŸ”„ RECONFâ”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚                â”‚
                         â–¼                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   pg2    â”‚      â”‚   pg3    â”‚
                    â”‚ PRIMARY  â”‚â—€â”€â”€â”€â”€â”€â”‚ ğŸ”„ RECONFâ”‚
                    â”‚  TL: 2   â”‚ WAL  â”‚  TL: 1â†’2 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Reconfiguration Steps on pg3:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Detect new leader from etcd                   â”‚
â”‚   â†’ Read /db/pgcluster/leader                         â”‚
â”‚   â†’ New leader: node2                                 â”‚
â”‚   â†’ Get connection info from etcd                     â”‚
â”‚                                                        â”‚
â”‚ Step 2: Stop PostgreSQL                               â”‚
â”‚   $ pg_ctl stop -D /home/postgres/data                â”‚
â”‚                                                        â”‚
â”‚ Step 3: Update primary_conninfo                       â”‚
â”‚   primary_conninfo = 'host=pg2 port=5432              â”‚
â”‚                       user=replicator                 â”‚
â”‚                       password=rep_password'          â”‚
â”‚                                                        â”‚
â”‚ Step 4: Create recovery.signal                        â”‚
â”‚   $ touch /home/postgres/data/recovery.signal         â”‚
â”‚                                                        â”‚
â”‚ Step 5: Start PostgreSQL in standby mode              â”‚
â”‚   $ pg_ctl start -D /home/postgres/data               â”‚
â”‚   â†’ Connects to pg2                                   â”‚
â”‚   â†’ Starts streaming WAL from pg2                     â”‚
â”‚   â†’ Timeline updates: 1 â†’ 2                           â”‚
â”‚                                                        â”‚
â”‚ Step 6: Verify replication                            â”‚
â”‚   â†’ Check: SELECT status FROM pg_stat_wal_receiver    â”‚
â”‚   â†’ Result: streaming âœ“                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Events:
[00:00:25] pg3 detects new leader (node2) from etcd
[00:00:26] pg3 stops PostgreSQL
[00:00:27] pg3 updates replication configuration
[00:00:28] pg3 starts PostgreSQL in standby mode
[00:00:29] pg3 connects to pg2 and starts streaming
[00:00:30] pg3 timeline updates to 2
```

---

### T=30s: HAProxy Detects New Leader

```
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ HAProxy  â”‚
                   â”‚ :54320   â”‚
                   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
   Health Check     Health Check     Health Check
   GET /primary     GET /primary     GET /primary
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Patroni â”‚      â”‚ Patroni â”‚      â”‚ Patroni â”‚
   â”‚  node1  â”‚      â”‚  node2  â”‚      â”‚  node3  â”‚
   â”‚  ğŸ’€ FAIL â”‚      â”‚ âœ“ 200 OK â”‚      â”‚ âœ— 503   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚                â”‚
                         â–¼                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   pg2    â”‚      â”‚   pg3    â”‚
                    â”‚ PRIMARY  â”‚â”€â”€â”€â”€â”€â–¶â”‚ STANDBY  â”‚
                    â”‚  TL: 2   â”‚ WAL  â”‚  TL: 2   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

HAProxy Health Check Results:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pg1:8008/primary â†’ Connection refused âœ—               â”‚
â”‚   Status: DOWN                                         â”‚
â”‚   Action: Remove from backend pool                     â”‚
â”‚                                                        â”‚
â”‚ pg2:8008/primary â†’ HTTP 200 OK âœ“                      â”‚
â”‚   Response: {"state": "running", "role": "master"}    â”‚
â”‚   Status: UP                                           â”‚
â”‚   Action: Route all traffic here                      â”‚
â”‚                                                        â”‚
â”‚ pg3:8008/primary â†’ HTTP 503 Service Unavailable âœ—     â”‚
â”‚   Response: {"state": "running", "role": "replica"}   â”‚
â”‚   Status: DOWN (for primary traffic)                  â”‚
â”‚   Action: Keep as backup                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

HAProxy Backend Status:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend: pg_backend                                    â”‚
â”‚                                                        â”‚
â”‚ Server pg1: DOWN (health check failed)                â”‚
â”‚ Server pg2: UP (active, serving traffic) âœ“            â”‚
â”‚ Server pg3: DOWN (backup, not primary)                â”‚
â”‚                                                        â”‚
â”‚ Active Server: pg2                                     â”‚
â”‚ All connections routed to: pg2:5432                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Events:
[00:00:30] HAProxy health check detects pg1 is down
[00:00:30] HAProxy health check detects pg2 is primary
[00:00:30] HAProxy routes all traffic to pg2
[00:00:30] Applications reconnect to pg2 automatically
```

---

### T=35s: Cluster Fully Operational âœ…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        APLIKASI                                 â”‚
â”‚                  âœ“ Connected to pg2 via HAProxy                 â”‚
â”‚                  âœ“ All operations working                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ HAProxy  â”‚
                   â”‚ :54320   â”‚
                   â”‚ âœ“ Routingâ”‚
                   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ All traffic
                         â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Patroni â”‚
                    â”‚  node2  â”‚
                    â”‚ âœ“ LEADER â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   pg2    â”‚
                    â”‚ PRIMARY  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  TL: 2   â”‚ WAL Streaming   â”‚
                    â”‚ âœ“ R/W    â”‚                 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
                                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
                    â”‚ Patroni  â”‚                 â”‚
                    â”‚  node3   â”‚                 â”‚
                    â”‚ âœ“ REPLICAâ”‚                 â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                 â”‚
                         â”‚                       â”‚
                         â–¼                       â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
                    â”‚   pg3    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ STANDBY  â”‚
                    â”‚  TL: 2   â”‚
                    â”‚ âœ“ R/O    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Final State:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cluster: pgcluster                                     â”‚
â”‚ Timeline: 2                                            â”‚
â”‚                                                        â”‚
â”‚ node1 (pg1): DOWN (crashed)                           â”‚
â”‚ node2 (pg2): Leader, running, Timeline 2 âœ“            â”‚
â”‚ node3 (pg3): Replica, streaming, Lag: 0 MB âœ“          â”‚
â”‚                                                        â”‚
â”‚ HAProxy: Routing to pg2 âœ“                             â”‚
â”‚ Applications: Connected and working âœ“                  â”‚
â”‚ Data Loss: ZERO âœ“                                      â”‚
â”‚ Downtime: ~30 seconds                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   etcd   â”‚
                    â”‚  :2379   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    
Cluster State in etcd:
/db/pgcluster/
â”œâ”€â”€ leader: node2 (TTL: 30s, renewed every 10s)
â”œâ”€â”€ members/
â”‚   â”œâ”€â”€ node1: {"state": "stopped", "role": "replica"}
â”‚   â”œâ”€â”€ node2: {"state": "running", "role": "master", "timeline": 2}
â”‚   â””â”€â”€ node3: {"state": "running", "role": "replica", "timeline": 2}
â””â”€â”€ history: [
      {"timeline": 1, "leader": "node1", "end": "2025-11-15T16:00:00Z"},
      {"timeline": 2, "leader": "node2", "start": "2025-11-15T16:00:15Z"}
    ]

Events:
[00:00:35] Cluster fully operational
[00:00:35] pg2 is stable leader
[00:00:35] pg3 is streaming with 0 lag
[00:00:35] Applications working normally
[00:00:35] Failover complete! âœ…
```

---

## Summary Timeline

```
T=0s    ğŸ’¥ pg1 crashes
        â”‚
T=10s   ğŸ” pg2 & pg3 detect leader is down
        â”‚
T=15s   ğŸ† pg2 wins leader election
        â”‚
T=20s   ğŸ”„ pg2 promotes to primary (Timeline 2)
        â”‚
T=25s   ğŸ”„ pg3 reconfigures to follow pg2
        â”‚
T=30s   âœ“ HAProxy detects pg2 as new primary
        â”‚
T=35s   âœ… Cluster fully operational
        
Total Downtime: ~30 seconds
Data Loss: ZERO
```

## Key Metrics

| Metric | Value | Notes |
|--------|-------|-------|
| Detection Time | 10s | Time to detect leader failure |
| Election Time | 5s | Time to elect new leader |
| Promotion Time | 5s | Time to promote to primary |
| Reconfiguration Time | 5s | Time for replicas to reconfigure |
| HAProxy Detection | 5s | Time for HAProxy to detect new leader |
| **Total Downtime** | **~30s** | From crash to fully operational |
| **Data Loss** | **0 bytes** | Synchronous replication |
| Replication Lag | 0 MB | After recovery |

## What Prevents Data Loss?

1. **Synchronous Replication**
   - Primary waits for replica ACK before commit
   - Ensures data is on at least 2 nodes

2. **WAL Streaming**
   - Continuous replication of changes
   - No batch delays

3. **Timeline Management**
   - Prevents divergent histories
   - Ensures consistency

4. **etcd Consensus**
   - Only one leader at a time
   - No split-brain scenarios
