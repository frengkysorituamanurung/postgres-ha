services:
  etcd:
    image: quay.io/coreos/etcd:v3.5.15
    container_name: etcd
    command: >
      /usr/local/bin/etcd
      --name etcd0
      --data-dir /etcd-data
      --advertise-client-urls http://etcd:2379
      --listen-client-urls http://0.0.0.0:2379
      --initial-advertise-peer-urls http://etcd:2380
      --listen-peer-urls http://0.0.0.0:2380
      --initial-cluster etcd0=http://etcd:2380
      --initial-cluster-token pg-ha
      --initial-cluster-state new
    ports:
      - "2379:2379"
      - "2380:2380"
    volumes:
      - etcd-data:/etcd-data
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 5s
      timeout: 3s
      retries: 5

  pg1:
    build:
      context: .
      dockerfile: Dockerfile.patroni
    container_name: pg1
    environment:
      PATRONI_SCOPE: pgcluster
      PATRONI_NAME: node1
      POSTGRES_PASSWORD: admin_password
    volumes:
      - ./patroni/node1.yml:/etc/patroni.yml:ro
    command: patroni /etc/patroni.yml
    depends_on:
      etcd:
        condition: service_healthy
    ports:
      - "5431:5432"
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 5s
      timeout: 3s
      retries: 5

  pg2:
    build:
      context: .
      dockerfile: Dockerfile.patroni
    container_name: pg2
    environment:
      PATRONI_SCOPE: pgcluster
      PATRONI_NAME: node2
      POSTGRES_PASSWORD: admin_password
    volumes:
      - ./patroni/node2.yml:/etc/patroni.yml:ro
    command: patroni /etc/patroni.yml
    depends_on:
      etcd:
        condition: service_healthy
    ports:
      - "5432:5432"

  pg3:
    build:
      context: .
      dockerfile: Dockerfile.patroni
    container_name: pg3
    environment:
      PATRONI_SCOPE: pgcluster
      PATRONI_NAME: node3
      POSTGRES_PASSWORD: admin_password
    volumes:
      - ./patroni/node3.yml:/etc/patroni.yml:ro
    command: patroni /etc/patroni.yml
    depends_on:
      etcd:
        condition: service_healthy
    ports:
      - "5433:5432"

  haproxy:
    image: haproxy:2.9
    container_name: haproxy
    ports:
      - "54320:5432"  # Aplikasi connect ke localhost:54320
      - "7000:7000"   # HAProxy stats page
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    depends_on:
      - pg1
      - pg2
      - pg3

volumes:
  etcd-data: